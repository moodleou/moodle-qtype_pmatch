{"version":3,"file":"rulecreator.min.js","sources":["../src/rulecreator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This class provides functionality for the rule creation assistant.\n *\n * This is based on the work of Dr Alistair Willis published:\n * http://aclweb.org/anthology/W/W15/W15-0628.pdf\n *\n * @class     rulecreator\n * @copyright 2016 The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since     2.9\n */\ndefine(['jquery'], function($) {\n\n    /**\n     * @alias qtype_pmatch/rulecreator\n     */\n    const t = {\n        store: {},\n\n        /**\n         * Initialise the rule creation assistant.\n         */\n        init: function() {\n            $('textarea[name^=\"answer\"]').each(function() {\n                const id = $(this).attr('id').replace('id_answer_', '');\n                const ref = 'id_' + id;\n                t.store[ref] = [];\n                // Hide the 'show/hide rule creator assistant' unless there is no existing rule.\n                // It would be much better to not show this element unless js is enabled, but\n                // using a static element means we cannot add classes to enable this.\n                if ($(this).val() !== '' && $(this).val() !== 'match ()') {\n                    $(this).parent().parent().next().addClass('rc-hidden');\n                } else {\n                    $(this).parent().parent().next().addClass('rcw');\n                }\n                const rc = $(this).parent().parent().next().find('div.rule-creator');\n                // Add ids to make things easier, and add button clicks.\n                rc.attr('id', 'rc_' + id);\n                $(this).parent().parent().next().find('a.rule-creator-btn').attr('id', 'rc_btn_' + id);\n                rc.find('div[class=\"rc-notice\"]').attr('id', 'rc_notice_' + id);\n                rc.find('label[for=\"term\"]').attr('for', 'rc_term_' + id);\n                rc.find('input[name=\"term\"]').attr('id', 'rc_term_' + id);\n                rc.find('input[name=\"termadd\"]').attr('id', 'rc_termadd_' + id).click(function() {\n                    t.termAdd(id);\n                    return false;\n                });\n                rc.find('input[name=\"termexclude\"]').attr('id', 'rc_termexclude_' + id).click(function() {\n                    t.termExclude(id);\n                    return false;\n                });\n                rc.find('input[name=\"termor\"]').attr('id', 'rc_termor_' + id).click(function() {\n                    t.termOr(id);\n                    return false;\n                });\n                rc.find('label[for=\"template\"]').attr('for', 'rc_template_' + id);\n                rc.find('input[name=\"template\"]').attr('id', 'rc_template_' + id);\n                rc.find('input[name=\"templateadd\"]').attr('id', 'rc_templateadd_' + id).click(function() {\n                    t.templateAdd(id);\n                    return false;\n                });\n                rc.find('input[name=\"templateexclude\"]').attr('id', 'rc_templateexclude_' + id).click(function() {\n                    t.templateExclude(id);\n                    return false;\n                });\n                rc.find('label[for=\"precedesadd\"]').attr('for', 'rc_precedes1_' + id);\n                rc.find('select[name=\"precedes1\"]').attr('id', 'rc_precedes1_' + id);\n                rc.find('select[name=\"precedes2\"]').attr('id', 'rc_precedes2_' + id);\n                rc.find('input[name=\"precedesadd\"]').attr('id', 'rc_precedesadd_' + id).click(function() {\n                    t.precedesAdd(id);\n                    return false;\n                });\n                rc.find('label[for=\"cprecedesadd\"]').attr('for', 'rc_cprecedes1_' + id);\n                rc.find('select[name=\"cprecedes1\"]').attr('id', 'rc_cprecedes1_' + id);\n                rc.find('select[name=\"cprecedes2\"]').attr('id', 'rc_cprecedes2_' + id);\n                rc.find('input[name=\"cprecedesadd\"]').attr('id', 'rc_cprecedesadd_' + id).click(function() {\n                    t.cprecedesAdd(id);\n                    return false;\n                });\n                rc.find('div.rc-result').attr('id', 'rc_result_' + id);\n                rc.find('input[name=\"add\"]').attr('id', 'rc_add_' + id).click(function() {\n                    t.addToAnswer(id);\n                    return false;\n                });\n                rc.find('input[name=\"clear\"]').attr('id', 'rc_clear_' + id).click(function() {\n                    t.clear(id);\n                    return false;\n                });\n            });\n            $('.rule-creator-btn').click(function(e) {\n                const wrapper = $(e.target).closest('.fitem.rcw');\n                const icon = $(e.target).closest('.rule-creator-btn').find('img.icon');\n                let src = icon.attr('src');\n                wrapper.find('.rule-creator').slideToggle();\n                if (src === undefined) {\n                    return false;\n                }\n                if (src.indexOf('collapsed') > 0) {\n                    src = src.slice(0, -9) + 'expanded';\n                } else {\n                    src = src.slice(0, -8) + 'collapsed';\n                }\n                icon.attr('src', src);\n                return false;\n            });\n        },\n\n        termAdd: function(id) {\n            const term = this.getTerm(id, 'term');\n            if (!term) {\n                $('#rc_term_' + id).focus();\n                return;\n            }\n            const termid = this.addToStore(id, term, 'and', 'term');\n            this.addToPrecedes(id, termid, term);\n            this.displayResult(id);\n            $('#rc_term_' + id).val('');\n        },\n\n        termExclude: function(id) {\n            const term = this.getTerm(id, 'term');\n            if (!term) {\n                $('#rc_term_' + id).focus();\n                return;\n            }\n            this.addToStore(id, term, 'not', 'term');\n            this.disablePrecedes(id, true);\n            this.displayResult(id);\n            $('#rc_term_' + id).val('');\n        },\n\n        termOr: function(id) {\n            const term = this.getTerm(id, 'term');\n            if (!term) {\n                $('#rc_term_' + id).focus();\n                return;\n            }\n            const termid = this.addToStore(id, term, 'or', 'term');\n            this.addToPrecedes(id, termid, term);\n            this.displayResult(id);\n            $('#rc_term_' + id).val('');\n        },\n\n        templateAdd: function(id) {\n            const term = this.getTerm(id, 'template');\n            if (!term) {\n                $('#rc_template_' + id).focus();\n                return;\n            }\n            const termid = this.addToStore(id, term, 'and', 'template');\n            this.addToPrecedes(id, termid, term);\n            this.displayResult(id);\n            $('#rc_template_' + id).val('');\n        },\n\n        templateExclude: function(id) {\n            const term = this.getTerm(id, 'template');\n            if (!term) {\n                $('#rc_template_' + id).focus();\n                return;\n            }\n            this.addToStore(id, term, 'not', 'template');\n            this.disablePrecedes(id, true);\n            this.displayResult(id);\n            $('#rc_template_' + id).val('');\n        },\n\n        precedesAdd: function(id) {\n            const terms = this.getPrecedesChoices(id, 'precedes');\n            if (!terms) {\n                return;\n            }\n            this.addToStore(id, terms, 'and', 'precedes');\n            this.removeFromPrecedes(id, terms);\n            this.displayResult(id);\n        },\n\n        cprecedesAdd: function(id) {\n            const terms = this.getPrecedesChoices(id, 'cprecedes');\n            if (!terms) {\n                return;\n            }\n            this.addToStore(id, terms, 'and', 'cprecedes');\n            this.removeFromPrecedes(id, terms);\n            this.displayResult(id);\n        },\n\n        addToAnswer: function(id) {\n            const result = $('#rc_result_' + id).text();\n            if (result === null || result === '') {\n                return;\n            }\n            $('#id_answer_' + id).val(result);\n            this.clear();\n            $('#rc_btn_' + id).click();\n            $('#id_fraction_' + id).val('1.0').change();\n            $('#id_answer_' + id).focus();\n        },\n\n        clear: function(id) {\n            const ref = 'id_' + id;\n            this.store[ref] = [];\n            $('#rc_term_' + id).val('');\n            $('#rc_template_' + id).val('');\n            $('#rc_result_' + id).text('');\n            this.resetPrecedes(id);\n        },\n\n        getTerm: function(id, type) {\n            // Amati limits the number of terms to a max of 6.\n            if (this.getStoreLength(id) > 4) {\n                $('#rc_notice_' + id).text(M.util.get_string('rulecreationtoomanyterms', 'qtype_pmatch'));\n                return false;\n            }\n            let term = $('#rc_' + type + '_' + id).val();\n            if (term === undefined || term === null || term === '') {\n                return false;\n            }\n            term = term.trim();\n            if (term === '') {\n                return false;\n            }\n            // Amati allows single character words, but only one word as a term or template.\n            if (term.indexOf(' ') > -1) {\n                return false;\n            }\n            // Note Pmatch relies on an underscore for closely precedes, so these cannot be included\n            // without escaping (\\_). Also applies to | [] ? and * (* is except for templates).\n            // Amati ignores apostrophies, numbers, special and extended characters etc.\n            // It seems to only work with [a-z][A-Z].\n            // Special care with the presence of a \\ may also be required.\n            if (term.indexOf('_') > -1) {\n                term = term.replace(/_/g, '\\\\_');\n            }\n            if (type === 'term') {\n                return term;\n            } else {\n                if (term.slice(-1) === '*') {\n                    return term;\n                } else {\n                    return term + '*';\n                }\n            }\n        },\n\n        getPrecedesChoices: function(id, type) {\n            const term1 = $('#rc_' + type + '1_' + id).val();\n            if (term1 === '0') {\n                $('#rc_' + type + '1_' + id).focus();\n                return false;\n            }\n            const term2 = $('#rc_' + type + '2_' + id).val();\n            if (term2 === '0') {\n                $('#rc_' + type + '2_' + id).focus();\n                return false;\n            }\n            if (term1 === term2) {\n                $('#rc_' + type + '2_' + id).focus();\n                return false;\n            }\n            return [term1, term2];\n        },\n\n        addToPrecedes: function(id, termid, term) {\n            $('#rc_precedes1_' + id).append($('<option>', {value: termid}).text(term));\n            $('#rc_precedes2_' + id).append($('<option>', {value: termid}).text(term));\n            $('#rc_cprecedes1_' + id).append($('<option>', {value: termid}).text(term));\n            $('#rc_cprecedes2_' + id).append($('<option>', {value: termid}).text(term));\n        },\n\n        disablePrecedes: function(id, type) {\n            $('#rc_precedes1_' + id).prop('disabled', type);\n            $('#rc_precedes2_' + id).prop('disabled', type);\n            $('#rc_cprecedes1_' + id).prop('disabled', type);\n            $('#rc_cprecedes2_' + id).prop('disabled', type);\n        },\n\n        resetPrecedes: function(id) {\n            this.disablePrecedes(id, false);\n            $('#rc_precedes1_' + id).find('option[value!=\"0\"]').remove();\n            $('#rc_precedes2_' + id).find('option[value!=\"0\"]').remove();\n            $('#rc_cprecedes1_' + id).find('option[value!=\"0\"]').remove();\n            $('#rc_cprecedes2_' + id).find('option[value!=\"0\"]').remove();\n        },\n\n        removeFromPrecedes: function(id, terms) {\n            for (let i = 0; i < 2; i++) {\n                $('#rc_precedes1_' + id + ' option[value=\"' + terms[i] + '\"]').remove();\n                $('#rc_precedes2_' + id + ' option[value=\"' + terms[i] + '\"]').remove();\n                $('#rc_cprecedes1_' + id + ' option[value=\"' + terms[i] + '\"]').remove();\n                $('#rc_cprecedes2_' + id + ' option[value=\"' + terms[i] + '\"]').remove();\n            }\n        },\n\n        addToStore: function(id, term, op, type) {\n            const ref = 'id_' + id;\n            const termid = this.store[ref].length + 1;\n            this.store[ref].push({termid: termid, term: term, op: op, type: type});\n            return termid;\n        },\n\n        getStoreLength: function(id) {\n            const ref = 'id_' + id;\n            return this.store[ref].length;\n        },\n        /* eslint-disable complexity, max-depth */\n        getStoredResult: function(id) {\n            const ref = 'id_' + id;\n            let rule = '';\n            // Temporary store of rule elements.\n            let temp = [];\n            // Clone the bit of the store we are interested in, so we can change elements.\n            const mystore = this.store[ref].slice(0);\n            let num = mystore.length;\n            let first = 0;\n            let second = 0;\n            let orpos = [];\n            let orcount = 0;\n            if (num === 0) {\n                return rule;\n            }\n            for (let i = 0; i < num; i++) {\n                let currentterm = '';\n                if (mystore[i].type === 'term') {\n                    if (mystore[i].op === 'and') {\n                        currentterm = 'match_w(' + mystore[i].term + ')';\n                    }\n                    if (mystore[i].op === 'or') {\n                        currentterm = 'match_w(' + mystore[i].term + ')';\n                        if (i > 0) {\n                            // The first item is not really an 'or'.\n                            orpos.push(i);\n                        }\n                    }\n                    if (mystore[i].op === 'not') {\n                        currentterm = 'not(match_w(' + mystore[i].term + '))';\n                    }\n                }\n                if (mystore[i].type === 'template') {\n                    if (mystore[i].op === 'and') {\n                        currentterm = 'match_wm(' + mystore[i].term + ')';\n                    }\n                    if (mystore[i].op === 'not') {\n                        currentterm = 'match_wm(' + mystore[i].term + ')';\n                    }\n                }\n                if (mystore[i].type === 'precedes') {\n                    first = mystore[i].term[0] - 1;\n                    second = mystore[i].term[1] - 1;\n                    currentterm = ' match_w(' + mystore[first].term + ' ' + mystore[second].term + ')';\n                }\n                if (mystore[i].type === 'cprecedes') {\n                    first = mystore[i].term[0] - 1;\n                    second = mystore[i].term[1] - 1;\n                    currentterm = ' match_w(' + mystore[first].term + '_' + mystore[second].term + ')';\n                }\n                temp.push(currentterm);\n            }\n            num = temp.length;\n            // Simplest scenarios first.\n            if (num === 0) {\n                return '';\n            }\n            if (num === 1) {\n                return temp[0];\n            }\n            orcount = orpos.length;\n            if (orcount === 0) {\n                // For term, template, precedes or closely precedes and press 'add' or 'exclude'.\n                // So no 'or' pressed, e.g. a add, b add. (Type a in term, press 'add', then ...)\n                rule = 'match_all(\\n  ' + temp[0];\n                for (let i = 1; i < num; i++) {\n                    rule = rule + ' ' + temp[i];\n                }\n                rule = rule + '\\n)';\n                return rule;\n            }\n            if (num === (orcount + 1)) {\n                // For a or, b or; a add, b or, c or.\n                rule = 'match_any(\\n  ' + temp[0];\n                for (let i = 1; i < num; i++) {\n                    rule = rule + ' ' + temp[i];\n                }\n                rule = rule + '\\n)';\n                return rule;\n            }\n            // And the more tricky scenarios.\n            if (orcount === 1) {\n                if (orpos[0] === 1) { // Note orpos[0] can never be 0).\n                    if (num === 2) {\n                        // For a add, b or.\n                        rule = 'match_any(\\n  ' + temp[0] + ' ' + temp[1] + '\\n)';\n                    } else {\n                        // For a add, b or, c add.\n                        rule = 'match_all(\\n  match_any(\\n    ' + temp[0] + ' ' + temp[1] + '\\n  )\\n ';\n                        for (let i = 2; i < num; i++) {\n                            rule = rule + ' ' + temp[i];\n                        }\n                        rule = rule + '\\n)';\n                    }\n                } else {\n                    // For a add, b add, c or.\n                    rule = 'match_all(\\n    ' + temp[0];\n                    for (let i = 1; i < orpos[0]; i++) {\n                        rule = rule + ' ' + temp[i];\n                    }\n                    rule = 'match_any(\\n  ' + rule + '\\n  )\\n  ' + temp[orpos[0]] + '\\n)';\n                    if (num > (orpos[0] + 1)) {\n                        // For a add, b add, c or, d add.\n                        rule = 'match_all(\\n' + rule + '\\n';\n                        for (let i = orpos[0] + 1; i < num; i++) {\n                            rule = rule + ' ' + temp[i];\n                        }\n                        rule = rule + '\\n)';\n                    }\n                }\n            } else if (orcount === 2) {\n                if (orpos[0] === 1) {\n                    rule = 'match_any(\\n  ' + temp[0] + ' ' + temp[1];\n                    if (orpos[1] === 2) {\n                        // For a add, b or, c or, d add.\n                        rule = 'match_all(\\n' + rule + ' ' + temp[2] + '\\n)\\n';\n                        for (let i = 3; i < num; i++) {\n                            rule = rule + ' ' + temp[i];\n                        }\n                        rule = rule + '\\n)';\n                    } else {\n                        // For a add, b or, c add, d or.\n                        rule = 'match_all(\\n' + rule + '\\n)\\n';\n                        for (let i = 2; i < orpos[1]; i++) {\n                            rule = rule + ' ' + temp[i];\n                        }\n                        rule = 'match_any(\\n' + rule + '\\n)\\n ' + temp[orpos[1]];\n                        if (num > (orpos[1] + 1)) {\n                            // For a add, b or, c add, d or, e add.\n                            rule = '\\nmatch_all(\\n' + rule;\n                            for (let i = orpos[1] + 1; i < num; i++) {\n                                rule = rule + ' ' + temp[i];\n                            }\n                            rule = rule + '\\n)';\n                        }\n                        rule = rule + '\\n)';\n                    }\n                } else {\n                    // For a add, b add, c or, d or/add.\n                    rule = 'match_all(\\n' + temp[0];\n                    for (let i = 1; i < orpos[0]; i++) {\n                        rule = rule + ' ' + temp[i];\n                    }\n                    // For a add, b add, c or.\n                    rule = 'match_any(\\n' + rule + '\\n)\\n  ' + temp[orpos[0]];\n                    if (orpos[1] === orpos[0] + 1) {\n                        // For a add, b add, c or, d or.\n                        rule = rule + ' ' + temp[orpos[1]] + '\\n)\\n';\n                        if (num > (orpos[1] + 1)) {\n                            // For a add, b add, c or, d or, e add.\n                            rule = 'match_all(\\n' + rule;\n                            for (let i = orpos[1] + 1; i < num; i++) {\n                                rule = rule + ' ' + temp[i];\n                            }\n                            rule = rule + '\\n)';\n                        }\n                    } else {\n                        rule = 'match_all(\\n' + rule + '\\n)\\n';\n                        for (let i = orpos[0] + 1; i < orpos[1]; i++) {\n                            rule = rule + ' ' + temp[i];\n                        }\n                        // For a add, b add, c or, d add, e or.\n                        rule = 'match_any(\\n' + rule + '\\n)\\n' + temp[orpos[1]] + '\\n)\\n';\n                        if (num > (orpos[1] + 1)) {\n                            // For a add, b add, c or, d add, e or, f add.\n                            rule = 'match_all(\\n' + rule;\n                            for (let i = orpos[1] + 1; i < num; i++) {\n                                rule = rule + ' ' + temp[i];\n                            }\n                            rule = rule + '\\n)\\n';\n                        }\n                    }\n                }\n            } else {\n                // Currently this simple interface cannot cope with more than two 'or's,\n                // though adding all or's will work.\n                $('#rc_notice_' + id).text(M.util.get_string('rulecreationtoomanyors', 'qtype_pmatch'));\n                return '';\n            }\n            return rule.trim();\n        },\n        /* eslint-enable complexity, max-depth */\n        displayResult: function(id) {\n            const result = this.getStoredResult(id);\n            $('#rc_result_' + id).text(result);\n        }\n    };\n\n    return t;\n});\n"],"names":["define","$","t","store","init","each","id","this","attr","replace","ref","val","parent","next","addClass","rc","find","click","termAdd","termExclude","termOr","templateAdd","templateExclude","precedesAdd","cprecedesAdd","addToAnswer","clear","e","wrapper","target","closest","icon","src","slideToggle","undefined","indexOf","slice","term","getTerm","focus","termid","addToStore","addToPrecedes","displayResult","disablePrecedes","terms","getPrecedesChoices","removeFromPrecedes","result","text","change","resetPrecedes","type","getStoreLength","M","util","get_string","trim","term1","term2","append","value","prop","remove","i","op","length","push","getStoredResult","rule","temp","mystore","num","first","second","orpos","orcount","currentterm"],"mappings":"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"}